###############################################################################
#                                                                             #
# IAR C/C++ Compiler V7.51A/W32 for 8051                30/May/2015  21:45:58 #
# Copyright 2004-2009 IAR Systems AB.                                         #
#                                                                             #
#    Core               =  plain                                              #
#    Code model         =  banked                                             #
#    Data model         =  large                                              #
#    Calling convention =  xdata reentrant                                    #
#    Constant location  =  data_rom                                           #
#    Dptr setup         =  1,16                                               #
#    Source file        =  C:\Texas Instruments\ZStack-CC2530-2.3.0-1.4.0\Com #
#                          ponents\hal\target\CC2530EB\hal_flash.c            #
#    Command line       =  -f "C:\Texas Instruments\ZStack-CC2530-2.3.0-1.4.0 #
#                          \Projects\zstack\Samples\ParkingS\CC2530DB\..\..\. #
#                          .\Tools\CC2530DB\f8wEndev.cfg" (-DCPU32MHZ         #
#                          -DROOT=__near_func -DBLINK_LEDS) -f "C:\Texas      #
#                          Instruments\ZStack-CC2530-2.3.0-1.4.0\Projects\zst #
#                          ack\Samples\ParkingS\CC2530DB\..\..\..\Tools\CC253 #
#                          0DB\f8wConfig.cfg" (-DSECURE=0                     #
#                          -DZG_SECURE_DYNAMIC=0 -DREFLECTOR                  #
#                          -DDEFAULT_CHANLIST=0x00000800                      #
#                          -DZDAPP_CONFIG_PAN_ID=0xFFFF                       #
#                          -DNWK_START_DELAY=100 -DEXTENDED_JOINING_RANDOM_MA #
#                          SK=0x007F -DBEACON_REQUEST_DELAY=100               #
#                          -DBEACON_REQ_DELAY_MASK=0x00FF                     #
#                          -DROUTE_EXPIRY_TIME=30 -DAPSC_ACK_WAIT_DURATION_PO #
#                          LLED=3000 -DNWK_INDIRECT_MSG_TIMEOUT=7             #
#                          -DMAX_RREQ_ENTRIES=8 -DAPSC_MAX_FRAME_RETRIES=3    #
#                          -DNWK_MAX_DATA_RETRIES=2                           #
#                          -DMAX_POLL_FAILURE_RETRIES=2 -DMAX_BCAST=9         #
#                          -DAPS_MAX_GROUPS=16 -DMAX_RTG_ENTRIES=40           #
#                          -DNWK_MAX_BINDING_ENTRIES=4                        #
#                          -DMAX_BINDING_CLUSTER_IDS=4 "-DDEFAULT_KEY={0x01,  #
#                          0x03, 0x05, 0x07, 0x09, 0x0B, 0x0D, 0x0F, 0x00,    #
#                          0x02, 0x04, 0x06, 0x08, 0x0A, 0x0C, 0x0D}"         #
#                          -DMAC_MAX_FRAME_SIZE=116 "-DCONST=const __code"    #
#                          -DGENERIC=__generic -DRFD_RCVC_ALWAYS_ON=FALSE     #
#                          -DPOLL_RATE=1000 -DQUEUED_POLL_RATE=100            #
#                          -DRESPONSE_POLL_RATE=100) -DREJOIN_POLL_RATE=440   #
#                          "C:\Texas Instruments\ZStack-CC2530-2.3.0-1.4.0\Co #
#                          mponents\hal\target\CC2530EB\hal_flash.c" -D       #
#                          NWK_AUTO_POLL -D ENDDEVICE -D ZTOOL_P1 -D MT_TASK  #
#                          -D MT_SYS_FUNC -D MT_ZDO_FUNC -D                   #
#                          SerialApp_CallBack -D xLCD_SUPPORTED=DEBUG -lC     #
#                          "C:\Texas Instruments\ZStack-CC2530-2.3.0-1.4.0\Pr #
#                          ojects\zstack\Samples\ParkingS\CC2530DB\EndDeviceE #
#                          B\List\" -lA "C:\Texas Instruments\ZStack-CC2530-2 #
#                          .3.0-1.4.0\Projects\zstack\Samples\ParkingS\CC2530 #
#                          DB\EndDeviceEB\List\" --diag_suppress Pe001,Pa010  #
#                          -o "C:\Texas Instruments\ZStack-CC2530-2.3.0-1.4.0 #
#                          \Projects\zstack\Samples\ParkingS\CC2530DB\EndDevi #
#                          ceEB\Obj\" -e --require_prototypes --debug         #
#                          --core=plain --dptr=16,1 --data_model=large        #
#                          --code_model=banked --calling_convention=xdata_ree #
#                          ntrant --place_constants=data_rom                  #
#                          --nr_virtual_regs 16 -I "C:\Texas                  #
#                          Instruments\ZStack-CC2530-2.3.0-1.4.0\Projects\zst #
#                          ack\Samples\ParkingS\CC2530DB\" -I "C:\Texas       #
#                          Instruments\ZStack-CC2530-2.3.0-1.4.0\Projects\zst #
#                          ack\Samples\ParkingS\CC2530DB\..\SOURCE\" -I       #
#                          "C:\Texas Instruments\ZStack-CC2530-2.3.0-1.4.0\Pr #
#                          ojects\zstack\Samples\ParkingS\CC2530DB\..\..\..\Z #
#                          MAIN\TI2530DB\" -I "C:\Texas                       #
#                          Instruments\ZStack-CC2530-2.3.0-1.4.0\Projects\zst #
#                          ack\Samples\ParkingS\CC2530DB\..\..\..\..\..\COMPO #
#                          NENTS\MT\" -I "C:\Texas Instruments\ZStack-CC2530- #
#                          2.3.0-1.4.0\Projects\zstack\Samples\ParkingS\CC253 #
#                          0DB\..\..\..\..\..\COMPONENTS\HAL\INCLUDE\" -I     #
#                          "C:\Texas Instruments\ZStack-CC2530-2.3.0-1.4.0\Pr #
#                          ojects\zstack\Samples\ParkingS\CC2530DB\..\..\..\. #
#                          .\..\COMPONENTS\HAL\TARGET\CC2530EB\" -I           #
#                          "C:\Texas Instruments\ZStack-CC2530-2.3.0-1.4.0\Pr #
#                          ojects\zstack\Samples\ParkingS\CC2530DB\..\..\..\. #
#                          .\..\COMPONENTS\OSAL\MCU\CCSOC\" -I "C:\Texas      #
#                          Instruments\ZStack-CC2530-2.3.0-1.4.0\Projects\zst #
#                          ack\Samples\ParkingS\CC2530DB\..\..\..\..\..\COMPO #
#                          NENTS\OSAL\INCLUDE\" -I "C:\Texas                  #
#                          Instruments\ZStack-CC2530-2.3.0-1.4.0\Projects\zst #
#                          ack\Samples\ParkingS\CC2530DB\..\..\..\..\..\COMPO #
#                          NENTS\STACK\AF\" -I "C:\Texas                      #
#                          Instruments\ZStack-CC2530-2.3.0-1.4.0\Projects\zst #
#                          ack\Samples\ParkingS\CC2530DB\..\..\..\..\..\COMPO #
#                          NENTS\STACK\NWK\" -I "C:\Texas                     #
#                          Instruments\ZStack-CC2530-2.3.0-1.4.0\Projects\zst #
#                          ack\Samples\ParkingS\CC2530DB\..\..\..\..\..\COMPO #
#                          NENTS\STACK\SEC\" -I "C:\Texas                     #
#                          Instruments\ZStack-CC2530-2.3.0-1.4.0\Projects\zst #
#                          ack\Samples\ParkingS\CC2530DB\..\..\..\..\..\COMPO #
#                          NENTS\STACK\SAPI\" -I "C:\Texas                    #
#                          Instruments\ZStack-CC2530-2.3.0-1.4.0\Projects\zst #
#                          ack\Samples\ParkingS\CC2530DB\..\..\..\..\..\COMPO #
#                          NENTS\STACK\SYS\" -I "C:\Texas                     #
#                          Instruments\ZStack-CC2530-2.3.0-1.4.0\Projects\zst #
#                          ack\Samples\ParkingS\CC2530DB\..\..\..\..\..\COMPO #
#                          NENTS\STACK\ZDO\" -I "C:\Texas                     #
#                          Instruments\ZStack-CC2530-2.3.0-1.4.0\Projects\zst #
#                          ack\Samples\ParkingS\CC2530DB\..\..\..\..\..\COMPO #
#                          NENTS\ZMAC\F8W\" -I "C:\Texas                      #
#                          Instruments\ZStack-CC2530-2.3.0-1.4.0\Projects\zst #
#                          ack\Samples\ParkingS\CC2530DB\..\..\..\..\..\COMPO #
#                          NENTS\ZMAC\" -I "C:\Texas                          #
#                          Instruments\ZStack-CC2530-2.3.0-1.4.0\Projects\zst #
#                          ack\Samples\ParkingS\CC2530DB\..\..\..\..\..\COMPO #
#                          NENTS\SERVICES\SADDR\" -I "C:\Texas                #
#                          Instruments\ZStack-CC2530-2.3.0-1.4.0\Projects\zst #
#                          ack\Samples\ParkingS\CC2530DB\..\..\..\..\..\COMPO #
#                          NENTS\SERVICES\SDATA\" -I "C:\Texas                #
#                          Instruments\ZStack-CC2530-2.3.0-1.4.0\Projects\zst #
#                          ack\Samples\ParkingS\CC2530DB\..\..\..\..\..\COMPO #
#                          NENTS\MAC\INCLUDE\" -I "C:\Texas                   #
#                          Instruments\ZStack-CC2530-2.3.0-1.4.0\Projects\zst #
#                          ack\Samples\ParkingS\CC2530DB\..\..\..\..\..\COMPO #
#                          NENTS\MAC\HIGH_LEVEL\" -I "C:\Texas                #
#                          Instruments\ZStack-CC2530-2.3.0-1.4.0\Projects\zst #
#                          ack\Samples\ParkingS\CC2530DB\..\..\..\..\..\COMPO #
#                          NENTS\MAC\LOW_LEVEL\srf04\" -I "C:\Texas           #
#                          Instruments\ZStack-CC2530-2.3.0-1.4.0\Projects\zst #
#                          ack\Samples\ParkingS\CC2530DB\..\..\..\..\..\COMPO #
#                          NENTS\MAC\LOW_LEVEL\srf04\SINGLE_CHIP\" -I         #
#                          "C:\Program Files\IAR Systems\Embedded Workbench   #
#                          5.3\8051\INC\" -I "C:\Program Files\IAR            #
#                          Systems\Embedded Workbench 5.3\8051\INC\CLIB\"     #
#                          -Ohz                                               #
#    List file          =  C:\Texas Instruments\ZStack-CC2530-2.3.0-1.4.0\Pro #
#                          jects\zstack\Samples\ParkingS\CC2530DB\EndDeviceEB #
#                          \List\hal_flash.lst                                #
#    Object file        =  C:\Texas Instruments\ZStack-CC2530-2.3.0-1.4.0\Pro #
#                          jects\zstack\Samples\ParkingS\CC2530DB\EndDeviceEB #
#                          \Obj\hal_flash.r51                                 #
#                                                                             #
#                                                                             #
###############################################################################

C:\Texas Instruments\ZStack-CC2530-2.3.0-1.4.0\Components\hal\target\CC2530EB\hal_flash.c
      1          /**************************************************************************************************
      2            Filename:       _hal_flash.c
      3            Revised:        $Date:$
      4            Revision:       $Revision:$
      5          
      6            Description: This file contains the interface to the H/W Flash driver.
      7          
      8          
      9            Copyright 2006-2009 Texas Instruments Incorporated. All rights reserved.
     10          
     11            IMPORTANT: Your use of this Software is limited to those specific rights
     12            granted under the terms of a software license agreement between the user
     13            who downloaded the software, his/her employer (which must be your employer)
     14            and Texas Instruments Incorporated (the "License").  You may not use this
     15            Software unless you agree to abide by the terms of the License. The License
     16            limits your use, and you acknowledge, that the Software may not be modified,
     17            copied or distributed unless embedded on a Texas Instruments microcontroller
     18            or used solely and exclusively in conjunction with a Texas Instruments radio
     19            frequency transceiver, which is integrated into your product.  Other than for
     20            the foregoing purpose, you may not use, reproduce, copy, prepare derivative
     21            works of, modify, distribute, perform, display or sell this Software and/or
     22            its documentation for any purpose.
     23          
     24            YOU FURTHER ACKNOWLEDGE AND AGREE THAT THE SOFTWARE AND DOCUMENTATION ARE
     25            PROVIDED “AS IS” WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED,
     26            INCLUDING WITHOUT LIMITATION, ANY WARRANTY OF MERCHANTABILITY, TITLE,
     27            NON-INFRINGEMENT AND FITNESS FOR A PARTICULAR PURPOSE. IN NO EVENT SHALL
     28            TEXAS INSTRUMENTS OR ITS LICENSORS BE LIABLE OR OBLIGATED UNDER CONTRACT,
     29            NEGLIGENCE, STRICT LIABILITY, CONTRIBUTION, BREACH OF WARRANTY, OR OTHER
     30            LEGAL EQUITABLE THEORY ANY DIRECT OR INDIRECT DAMAGES OR EXPENSES
     31            INCLUDING BUT NOT LIMITED TO ANY INCIDENTAL, SPECIAL, INDIRECT, PUNITIVE
     32            OR CONSEQUENTIAL DAMAGES, LOST PROFITS OR LOST DATA, COST OF PROCUREMENT
     33            OF SUBSTITUTE GOODS, TECHNOLOGY, SERVICES, OR ANY CLAIMS BY THIRD PARTIES
     34            (INCLUDING BUT NOT LIMITED TO ANY DEFENSE THEREOF), OR OTHER SIMILAR COSTS.
     35          
     36            Should you have any questions regarding your right to use this Software,
     37            contact Texas Instruments Incorporated at www.TI.com.
     38          **************************************************************************************************/
     39          
     40          /* ------------------------------------------------------------------------------------------------
     41           *                                          Includes
     42           * ------------------------------------------------------------------------------------------------
     43           */
     44          
     45          #include "hal_board_cfg.h"

   \                                 In  segment SFR_AN, at 0xa8
   \   union <unnamed> volatile __sfr _A_IEN0
   \                     _A_IEN0:
   \   000000                DS 1

   \                                 In  segment SFR_AN, at 0xc7
   \   unsigned char volatile __sfr MEMCTR
   \                     MEMCTR:
   \   000000                DS 1

   \                                 In  segment SFR_AN, at 0xd1
   \   unsigned char volatile __sfr DMAIRQ
   \                     DMAIRQ:
   \   000000                DS 1

   \                                 In  segment SFR_AN, at 0xd6
   \   unsigned char volatile __sfr DMAARM
   \                     DMAARM:
   \   000000                DS 1
     46          #include "hal_dma.h"
     47          #include "hal_flash.h"
     48          #include "hal_types.h"
     49          
     50          /* ------------------------------------------------------------------------------------------------
     51           *                                           Macros
     52           * ------------------------------------------------------------------------------------------------
     53           */
     54          
     55          /* ------------------------------------------------------------------------------------------------
     56           *                                          Constants
     57           * ------------------------------------------------------------------------------------------------
     58           */
     59          
     60          // These values depend on RAM_CODE_FLASH in the .xcl file used.
     61          #if defined CC2530F64     // RemoTI is using 0x01DDD --> pg 3, offset 0x5DD.
     62          #define OSET_OF_RAM_CODE  0x5DD
     63          #define PAGE_OF_RAM_CODE  3
     64          #define SIZE_OF_RAM_CODE  0x23
     65          #elif defined HAL_OAD_BOOT_CODE
     66                                    // OAD boot code is using 0x7E3 --> pg 0, so same as offset 0x7E3.
     67          #define OSET_OF_RAM_CODE  0x7E3
     68          #define PAGE_OF_RAM_CODE  0
     69          #define SIZE_OF_RAM_CODE  0x1D
     70          #elif defined HAL_USB_BOOT_CODE
     71                                    // USB boot code is using 0x7DD --> pg 0, so same as offset 0x7DD.
     72          #define OSET_OF_RAM_CODE  0x7DD
     73          #define PAGE_OF_RAM_CODE  0
     74          #define SIZE_OF_RAM_CODE  0x23
     75          #else                     // Z-Stack is using 0x39EDD --> pg 51, offset 0x6DD.
     76          #define OSET_OF_RAM_CODE  0x6DD
     77          #define PAGE_OF_RAM_CODE  51
     78          #define SIZE_OF_RAM_CODE  0x23
     79          #endif
     80          
     81          /* ------------------------------------------------------------------------------------------------
     82           *                                          Typedefs
     83           * ------------------------------------------------------------------------------------------------
     84           */
     85          
     86          /* ------------------------------------------------------------------------------------------------
     87           *                                       Global Variables
     88           * ------------------------------------------------------------------------------------------------
     89           */
     90          
     91          /* ------------------------------------------------------------------------------------------------
     92           *                                       Global Functions
     93           * ------------------------------------------------------------------------------------------------
     94           */
     95          
     96          /* ------------------------------------------------------------------------------------------------
     97           *                                       Local Variables
     98           * ------------------------------------------------------------------------------------------------
     99           */
    100          
    101          #pragma location="RAM_CODE_XDATA"

   \                                 In  segment RAM_CODE_XDATA, align 1
    102          static __no_init uint8 ramCode[SIZE_OF_RAM_CODE];
   \                     ramCode:
   \   000000                DS 35
    103          
    104          /* ------------------------------------------------------------------------------------------------
    105           *                                       Local Functions
    106           * ------------------------------------------------------------------------------------------------
    107           */
    108          
    109          #pragma location="RAM_CODE_FLASH"
    110          #if defined HAL_OAD_BOOT_CODE
    111          static void HalFlashWriteTrigger(void);
    112          #else
    113          static __monitor void HalFlashWriteTrigger(void);
    114          #endif
    115          
    116          /**************************************************************************************************
    117           * @fn          HalFlashInit
    118           *
    119           * @brief       This function initializes the environment for this module.
    120           *
    121           * input parameters
    122           *
    123           * None.
    124           *
    125           * output parameters
    126           *
    127           * None.
    128           *
    129           * @return      None.
    130           **************************************************************************************************
    131           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    132          void HalFlashInit(void)
   \                     HalFlashInit:
    133          {
   \   000000   74F6         MOV     A,#-0xa
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 10
   \   000005                ; Auto size: 0
    134            // Load the code to run from RAM into its reserved area of RAM once at startup.
    135            HalFlashRead(PAGE_OF_RAM_CODE, OSET_OF_RAM_CODE, ramCode, SIZE_OF_RAM_CODE);
   \   000005                ; Setup parameters for call to function HalFlashRead
   \   000005   75..23       MOV     ?V0 + 0,#0x23
   \   000008   75..00       MOV     ?V0 + 1,#0x0
   \   00000B   78..         MOV     R0,#?V0 + 0
   \   00000D   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000010   7C..         MOV     R4,#(ramCode & 0xff)
   \   000012   7D..         MOV     R5,#((ramCode >> 8) & 0xff)
   \   000014   7ADD         MOV     R2,#-0x23
   \   000016   7B06         MOV     R3,#0x6
   \   000018   7933         MOV     R1,#0x33
   \   00001A   12....       LCALL   ??HalFlashRead?relay
   \   00001D   7402         MOV     A,#0x2
   \   00001F   12....       LCALL   ?DEALLOC_XSTACK8
    136          }
   \   000022                REQUIRE ?Subroutine0
   \   000022                ; // Fall through to label ?Subroutine0

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine0:
   \   000000   7F02         MOV     R7,#0x2
   \   000002   02....       LJMP    ?BANKED_LEAVE_XDATA
    137          
    138          /**************************************************************************************************
    139           * @fn          HalFlashRead
    140           *
    141           * @brief       This function reads 'cnt' bytes from the internal flash.
    142           *
    143           * input parameters
    144           *
    145           * @param       pg - A valid flash page number.
    146           * @param       offset - A valid offset into the page.
    147           * @param       buf - A valid buffer space at least as big as the 'cnt' parameter.
    148           * @param       cnt - A valid number of bytes to read.
    149           *
    150           * output parameters
    151           *
    152           * None.
    153           *
    154           * @return      None.
    155           **************************************************************************************************
    156           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    157          void HalFlashRead(uint8 pg, uint16 offset, uint8 *buf, uint16 cnt)
   \                     HalFlashRead:
    158          {
   \   000000   74F4         MOV     A,#-0xc
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 12
   \   000005                ; Auto size: 0
   \   000005   89..         MOV     ?V0 + 0,R1
   \   000007   740C         MOV     A,#0xc
   \   000009   12....       LCALL   ?XSTACK_DISP0_8
   \   00000C   E0           MOVX    A,@DPTR
   \   00000D   FE           MOV     R6,A
   \   00000E   A3           INC     DPTR
   \   00000F   E0           MOVX    A,@DPTR
   \   000010   FF           MOV     R7,A
    159            // Calculate the offset into the containing flash bank as it gets mapped into XDATA.
    160            uint8 *ptr = (uint8 *)(offset + HAL_FLASH_PAGE_MAP) +
    161                         ((pg % HAL_FLASH_PAGE_PER_BANK) * HAL_FLASH_PAGE_SIZE);
   \   000011   740F         MOV     A,#0xf
   \   000013   55..         ANL     A,?V0 + 0
   \   000015   F5..         MOV     ?V0 + 2,A
   \   000017   75..00       MOV     ?V0 + 3,#0x0
   \   00001A   740B         MOV     A,#0xb
   \   00001C   78..         MOV     R0,#?V0 + 2
   \   00001E   12....       LCALL   ?S_SHL
   \   000021   2A           ADD     A,R2
   \   000022   F8           MOV     R0,A
   \   000023   7480         MOV     A,#-0x80
   \   000025   3B           ADDC    A,R3
   \   000026   F9           MOV     R1,A
   \   000027   E4           CLR     A
   \   000028   28           ADD     A,R0
   \   000029   E5..         MOV     A,?V0 + 3
   \   00002B   39           ADDC    A,R1
   \   00002C   F9           MOV     R1,A
    162            uint8 memctr = MEMCTR;  // Save to restore.
   \   00002D   E5C7         MOV     A,0xc7
   \   00002F   F5..         MOV     ?V0 + 1,A
    163          
    164          #if !defined HAL_OAD_BOOT_CODE
    165            halIntState_t is;
    166          #endif
    167          
    168            pg /= HAL_FLASH_PAGE_PER_BANK;  // Calculate the flash bank from the flash page.
    169          
    170          #if !defined HAL_OAD_BOOT_CODE
    171            HAL_ENTER_CRITICAL_SECTION(is);
   \   000031   A2AF         MOV     C,0xa8.7
   \   000033   E4           CLR     A
   \   000034   92E0         MOV     0xE0 /* A   */.0,C
   \   000036   F5..         MOV     ?V0 + 2,A
   \   000038   C2AF         CLR     0xa8.7
    172          #endif
    173          
    174            // Calculate and map the containing flash bank into XDATA.
    175            MEMCTR = (MEMCTR & 0xF8) | pg;
   \   00003A   E5..         MOV     A,?V0 + 0
   \   00003C   C4           SWAP    A
   \   00003D   540F         ANL     A,#0xf
   \   00003F   C0E0         PUSH    A
   \   000041   74F8         MOV     A,#-0x8
   \   000043   55C7         ANL     A,0xc7
   \   000045   FA           MOV     R2,A
   \   000046   D0E0         POP     A
   \   000048   4A           ORL     A,R2
   \   000049   F5C7         MOV     0xc7,A
   \   00004B   801C         SJMP    ??HalFlashRead_0
    176          
    177            while (cnt--)
    178            {
    179              *buf++ = *ptr++;
   \                     ??HalFlashRead_1:
   \   00004D   8882         MOV     DPL,R0
   \   00004F   8983         MOV     DPH,R1
   \   000051   E0           MOVX    A,@DPTR
   \   000052   8C82         MOV     DPL,R4
   \   000054   8D83         MOV     DPH,R5
   \   000056   F0           MOVX    @DPTR,A
   \   000057   8882         MOV     DPL,R0
   \   000059   8983         MOV     DPH,R1
   \   00005B   A3           INC     DPTR
   \   00005C   A882         MOV     R0,DPL
   \   00005E   A983         MOV     R1,DPH
   \   000060   8C82         MOV     DPL,R4
   \   000062   8D83         MOV     DPH,R5
   \   000064   A3           INC     DPTR
   \   000065   AC82         MOV     R4,DPL
   \   000067   AD83         MOV     R5,DPH
    180            }
   \                     ??HalFlashRead_0:
   \   000069   EE           MOV     A,R6
   \   00006A   FA           MOV     R2,A
   \   00006B   EF           MOV     A,R7
   \   00006C   FB           MOV     R3,A
   \   00006D   74FF         MOV     A,#-0x1
   \   00006F   2A           ADD     A,R2
   \   000070   1E           DEC     R6
   \   000071   74FF         MOV     A,#-0x1
   \   000073   3B           ADDC    A,R3
   \   000074   FF           MOV     R7,A
   \   000075   EA           MOV     A,R2
   \   000076   7001         JNZ     ??HalFlashRead_2
   \   000078   EB           MOV     A,R3
   \                     ??HalFlashRead_2:
   \   000079   70D2         JNZ     ??HalFlashRead_1
    181          
    182            MEMCTR = memctr;
   \   00007B   85..C7       MOV     0xc7,?V0 + 1
    183          
    184          #if !defined HAL_OAD_BOOT_CODE
    185            HAL_EXIT_CRITICAL_SECTION(is);
   \   00007E   E5..         MOV     A,?V0 + 2
   \   000080   A2E0         MOV     C,0xE0 /* A   */.0
   \   000082   92AF         MOV     0xa8.7,C
    186          #endif
    187          }
   \   000084   7F04         MOV     R7,#0x4
   \   000086   02....       LJMP    ?BANKED_LEAVE_XDATA
   \   000089                REQUIRE _A_IEN0
   \   000089                REQUIRE MEMCTR
    188          
    189          /**************************************************************************************************
    190           * @fn          HalFlashWrite
    191           *
    192           * @brief       This function writes 'cnt' bytes to the internal flash.
    193           *
    194           * input parameters
    195           *
    196           * @param       addr - Valid HAL flash write address: actual addr / 4 and quad-aligned.
    197           * @param       buf - Valid buffer space at least as big as 'cnt' X 4.
    198           * @param       cnt - Number of 4-byte blocks to write.
    199           *
    200           * output parameters
    201           *
    202           * None.
    203           *
    204           * @return      None.
    205           **************************************************************************************************
    206           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    207          void HalFlashWrite(uint16 addr, uint8 *buf, uint16 cnt)
   \                     HalFlashWrite:
    208          {
   \   000000   74F6         MOV     A,#-0xa
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 10
   \   000005                ; Auto size: 0
   \   000005   740A         MOV     A,#0xa
   \   000007   12....       LCALL   ?XSTACK_DISP0_8
   \   00000A   E0           MOVX    A,@DPTR
   \   00000B   F5..         MOV     ?V0 + 0,A
   \   00000D   A3           INC     DPTR
   \   00000E   E0           MOVX    A,@DPTR
   \   00000F   F5..         MOV     ?V0 + 1,A
    209            halDMADesc_t *ch = HAL_NV_DMA_GET_DESC();
    210          
    211            HAL_DMA_SET_SOURCE(ch, buf);
   \   000011   ED           MOV     A,R5
   \   000012   90....       MOV     DPTR,#dmaCh0
   \   000015   F0           MOVX    @DPTR,A
   \   000016   EC           MOV     A,R4
   \   000017   90....       MOV     DPTR,#(dmaCh0 + 1)
   \   00001A   F0           MOVX    @DPTR,A
    212            HAL_DMA_SET_DEST(ch, &FWDATA);
   \   00001B   7462         MOV     A,#0x62
   \   00001D   90....       MOV     DPTR,#(dmaCh0 + 2)
   \   000020   F0           MOVX    @DPTR,A
   \   000021   7473         MOV     A,#0x73
   \   000023   90....       MOV     DPTR,#(dmaCh0 + 3)
   \   000026   F0           MOVX    @DPTR,A
    213            HAL_DMA_SET_VLEN(ch, HAL_DMA_VLEN_USE_LEN);
   \   000027   90....       MOV     DPTR,#(dmaCh0 + 4)
   \   00002A   E0           MOVX    A,@DPTR
   \   00002B   541F         ANL     A,#0x1f
   \   00002D   F0           MOVX    @DPTR,A
    214            HAL_DMA_SET_LEN(ch, (cnt * HAL_FLASH_WORD_SIZE));
   \   00002E   E5..         MOV     A,?V0 + 0
   \   000030   33           RLC     A
   \   000031   33           RLC     A
   \   000032   54FC         ANL     A,#0xfc
   \   000034   90....       MOV     DPTR,#(dmaCh0 + 5)
   \   000037   F0           MOVX    @DPTR,A
   \   000038   7406         MOV     A,#0x6
   \   00003A   78..         MOV     R0,#?V0 + 0
   \   00003C   12....       LCALL   ?US_SHR
   \   00003F   E5..         MOV     A,?V0 + 0
   \   000041   90....       MOV     DPTR,#(dmaCh0 + 4)
   \   000044   F0           MOVX    @DPTR,A
    215            HAL_DMA_SET_WORD_SIZE(ch, HAL_DMA_WORDSIZE_BYTE);
    216            HAL_DMA_SET_TRIG_MODE(ch, HAL_DMA_TMODE_SINGLE);
    217            HAL_DMA_SET_TRIG_SRC(ch, HAL_DMA_TRIG_FLASH);
   \   000045   7412         MOV     A,#0x12
   \   000047   90....       MOV     DPTR,#(dmaCh0 + 6)
   \   00004A   F0           MOVX    @DPTR,A
    218            HAL_DMA_SET_SRC_INC(ch, HAL_DMA_SRCINC_1);
    219            HAL_DMA_SET_DST_INC(ch, HAL_DMA_DSTINC_0);
    220            // The DMA is to be polled and shall not issue an IRQ upon completion.
    221            HAL_DMA_SET_IRQ(ch, HAL_DMA_IRQMASK_DISABLE);
    222            HAL_DMA_SET_M8( ch, HAL_DMA_M8_USE_8_BITS);
    223            HAL_DMA_SET_PRIORITY(ch, HAL_DMA_PRI_HIGH);
   \   00004B   7442         MOV     A,#0x42
   \   00004D   90....       MOV     DPTR,#(dmaCh0 + 7)
   \   000050   F0           MOVX    @DPTR,A
    224            HAL_DMA_CLEAR_IRQ(HAL_NV_DMA_CH);
   \   000051   53D1FE       ANL     0xd1,#0xfe
    225            HAL_DMA_ARM_CH(HAL_NV_DMA_CH);
   \   000054   75D601       MOV     0xd6,#0x1
    226          
    227            FADDRL = (uint8)addr;
   \   000057   EA           MOV     A,R2
   \   000058   906271       MOV     DPTR,#0x6271
   \   00005B   F0           MOVX    @DPTR,A
    228            FADDRH = (uint8)(addr >> 8);
   \   00005C   EB           MOV     A,R3
   \   00005D   906272       MOV     DPTR,#0x6272
   \   000060   F0           MOVX    @DPTR,A
    229            HalFlashWriteTrigger();
   \   000061                ; Setup parameters for call to function HalFlashWriteTrigger
   \   000061   12....       LCALL   ??HalFlashWriteTrigger?relay
    230          }
   \   000064   02....       LJMP    ?Subroutine0 & 0xFFFF
   \   000067                REQUIRE DMAIRQ
   \   000067                REQUIRE DMAARM
    231          
    232          /**************************************************************************************************
    233           * @fn          HalFlashErase
    234           *
    235           * @brief       This function erases the specified page of the internal flash.
    236           *
    237           * input parameters
    238           *
    239           * @param       pg - A valid flash page number to erase.
    240           *
    241           * output parameters
    242           *
    243           * None.
    244           *
    245           * @return      None.
    246           **************************************************************************************************
    247           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    248          void HalFlashErase(uint8 pg)
   \                     HalFlashErase:
    249          {
   \   000000   C082         PUSH    DPL
   \   000002   C083         PUSH    DPH
   \   000004                ; Saved register size: 2
   \   000004                ; Auto size: 0
    250            FADDRH = pg * (HAL_FLASH_PAGE_SIZE / HAL_FLASH_WORD_SIZE / 256);
   \   000004   E9           MOV     A,R1
   \   000005   C3           CLR     C
   \   000006   33           RLC     A
   \   000007   906272       MOV     DPTR,#0x6272
   \   00000A   F0           MOVX    @DPTR,A
    251            FCTL |= 0x01;
   \   00000B   906270       MOV     DPTR,#0x6270
   \   00000E   E0           MOVX    A,@DPTR
   \   00000F   D2E0         SETB    0xE0 /* A   */.0
   \   000011   F0           MOVX    @DPTR,A
    252          }
   \   000012   D083         POP     DPH
   \   000014   D082         POP     DPL
   \   000016   02....       LJMP    ?BRET
    253          
    254          /**************************************************************************************************
    255           * @fn          HalFlashWriteTrigger
    256           *
    257           * @brief       This function must be copied to RAM before running because it triggers and then
    258           *              awaits completion of Flash write, which can only be done from RAM.
    259           *
    260           * input parameters
    261           *
    262           * None.
    263           *
    264           * output parameters
    265           *
    266           * None.
    267           *
    268           * @return      None.
    269           **************************************************************************************************
    270           */
    271          #if defined HAL_OAD_BOOT_CODE
    272          #pragma optimize=medium
    273          static void HalFlashWriteTrigger(void)
    274          #else

   \                                 In  segment RAM_CODE_FLASH, align 1, keep-with-next
    275          static __monitor void HalFlashWriteTrigger(void)
   \                     HalFlashWriteTrigger:
    276          #endif
    277          {
   \   000000   C082         PUSH    DPL
   \   000002   C083         PUSH    DPH
   \   000004                ; Saved register size: 2
   \   000004                ; Auto size: 0
   \   000004   C0A8         PUSH    0xA8 /* IE  */
   \   000006   C2AF         CLR     0xA8 /* IE  */.7
    278            MEMCTR |= 0x08;       // Start the Memory Arbiter running CODE from RAM.
   \   000008   43C708       ORL     0xc7,#0x8
    279            FCTL |= 0x02;         // Trigger the DMA writes.
   \   00000B   906270       MOV     DPTR,#0x6270
   \   00000E   E0           MOVX    A,@DPTR
   \   00000F   D2E1         SETB    0xE0 /* A   */.1
   \   000011   F0           MOVX    @DPTR,A
    280            while (FCTL & 0x80);  // Wait until writing is done.
   \                     ??HalFlashWriteTrigger_0:
   \   000012   E0           MOVX    A,@DPTR
   \   000013   A2E7         MOV     C,0xE0 /* A   */.7
   \   000015   40FB         JC      ??HalFlashWriteTrigger_0
    281            MEMCTR &= ~0x08;      // Stop the Memory Arbiter.
   \   000017   53C7F7       ANL     0xc7,#0xf7
    282          }
   \   00001A   D0A8         POP     0xA8 /* IE  */
   \   00001C   D083         POP     DPH
   \   00001E   D082         POP     DPL
   \   000020   02....       LJMP    ?BRET
   \   000023                REQUIRE MEMCTR

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??HalFlashInit?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    HalFlashInit

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??HalFlashRead?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    HalFlashRead

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??HalFlashWrite?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    HalFlashWrite

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??HalFlashErase?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    HalFlashErase

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??HalFlashWriteTrigger?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    HalFlashWriteTrigger
    283          
    284          /**************************************************************************************************
    285          */

   Maximum stack usage in bytes:

     Function                  ISTACK PSTACK XSTACK
     --------                  ------ ------ ------
     HalFlashErase                 2      0      0
     HalFlashInit                  0      0     12
       -> HalFlashRead             0      0     24
     HalFlashRead                  1      0     24
     HalFlashWrite                 0      0     12
       -> HalFlashWriteTrigger     0      0     20
     HalFlashWriteTrigger          3      0     10


   Segment part sizes:

     Function/Label               Bytes
     --------------               -----
     _A_IEN0                         1
     MEMCTR                          1
     DMAIRQ                          1
     DMAARM                          1
     ramCode                        35
     HalFlashInit                   34
     ?Subroutine0                    5
     HalFlashRead                  137
     HalFlashWrite                 103
     HalFlashErase                  25
     HalFlashWriteTrigger           35
     ??HalFlashInit?relay            6
     ??HalFlashRead?relay            6
     ??HalFlashWrite?relay           6
     ??HalFlashErase?relay           6
     ??HalFlashWriteTrigger?relay    6

 
 304 bytes in segment BANKED_CODE
  30 bytes in segment BANK_RELAYS
  35 bytes in segment RAM_CODE_FLASH
  35 bytes in segment RAM_CODE_XDATA
   4 bytes in segment SFR_AN
 
 369 bytes of CODE  memory
   0 bytes of DATA  memory (+ 4 bytes shared)
  35 bytes of XDATA memory

Errors: none
Warnings: none
